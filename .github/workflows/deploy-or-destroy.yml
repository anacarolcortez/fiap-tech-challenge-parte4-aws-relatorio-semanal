name: Deploy or Destroy AWS Lambda on develop

on:
  push:
    branches:
      - develop

permissions:
  id-token: write
  contents: read

jobs:
  terraform:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-1
      AWS_ACCOUNT_ID: 757367947438
      TF_ACTION: apply # Altere para "apply" ou "destroy"
      ROLE_NAME: lambda-relatorio-role
      SNS_NAME: relatorio_feedbacks-sns
      RESOURCE_NAME: event_relatorio_sns
      FUNCTION_NAME: event-relatorio-sns
      PATH_JAVA: lambda/src/main/java/org/acme/lambda/WeeklyReportHandler.java"
      PATH_CLASS: org/acme/lambda/WeeklyReportHandler.class

    steps:
      # Iniciando e configurando
      - name: Checkout c√≥digo
        uses: actions/checkout@v3

      - name: Autenticar com AWS via OIDC
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::757367947438:role/GitHubOIDCRole
          aws-region: us-east-1

      - name: Verificar modo de opera√ß√£o
        run: echo "Iniciando workflow em modo $TF_ACTION"

      - name: Instalar Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Inicializar Terraform
        working-directory: infra
        run: terraform init

      - name: Validar Terraform
        working-directory: infra
        run: terraform validate

        # Verificar e Obter VPC pelo Name
      - name: Obter VPC
        run: |
          VPC_ID=$(aws ec2 describe-vpcs \
            --filters "Name=tag:Name,Values=app-vpc" \
            --query "Vpcs[0].VpcId" \
            --output text)
          
          if [ -z "$VPC_ID" ] || [ "$VPC_ID" = "None" ]; then
            echo "‚ùå VPC n√£o encontrada"
            exit 1
          fi
          echo "‚úÖ VPC encontrada"
          echo "VPC_ID=$VPC_ID" >> $GITHUB_ENV

      # Verificar existencia de Subnets e importar
      - name: Obter Subnets privadas
        run: |
          SUBNETS=$(aws ec2 describe-subnets \
            --filters \
              "Name=vpc-id,Values=${VPC_ID}" \
              "Name=tag:Name,Values=private-*" \
            --query "Subnets[*].SubnetId" \
            --output text)
          
          if [ -z "$SUBNETS" ]; then
            echo "‚ùå Nenhuma subnet privada encontrada"
            exit 1
          fi
          echo "‚úÖ $SUBNETS encontrada"
          SUBNET_IDS=$(echo $SUBNETS | sed 's/ /","/g')
          echo "TF_VAR_vpc_subnet_ids=[\"$SUBNET_IDS\"]" >> $GITHUB_ENV

      # Importar Security Group da Lambda
      - name: Obter Security Group da Lambda
        run: |
          SG_ID=$(aws ec2 describe-security-groups \
            --filters "Name=group-name,Values=lambda-sg" \
            --query "SecurityGroups[0].GroupId" \
            --output text)
          
          if [ -z "$SG_ID" ] || [ "$SG_ID" = "None" ]; then
            echo "‚ùå Security Group da Lambda n√£o encontrado"
            exit 1
          fi
          echo "‚úÖ Security Group da Lambda encontrada"
          echo "TF_VAR_lambda_security_group_id=$SG_ID" >> $GITHUB_ENV

      # Verificar exist√™ncia da IAM Role
      - name: Verificar exist√™ncia da IAM Role
        id: iam_role_check
        run: |
          if aws iam get-role --role-name "$ROLE_NAME" >/dev/null 2>&1; then
            echo "‚úÖ IAM Role encontrada"
            echo "role_exists=true" >> $GITHUB_OUTPUT
            echo "role_name=$ROLE_NAME" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è IAM Role n√£o encontrada"
            echo "role_exists=false" >> $GITHUB_OUTPUT
          fi

      # Importar IAM Role
      - name: Importar IAM Role
        if: steps.iam_role_check.outputs.role_exists == 'true'
        working-directory: infra
        run: |
          echo "Importando IAM Role..."
          terraform import aws_iam_role.lambda_exec_role "${{ steps.iam_role_check.outputs.role_name }}" || echo "IAM Role j√° importada ou n√£o existe"

      # Verificar exist√™ncia da IAM Policy
      - name: Verificar exist√™ncia da IAM Policy
        id: iam_policy_check
        run: |
          POLICY_ARN="arn:aws:iam::757367947438:policy/relatorio-feedbacks-policy"
          if aws iam get-policy --policy-arn "$POLICY_ARN" >/dev/null 2>&1; then
            echo "‚úÖ IAM Policy encontrada"
            echo "policy_exists=true" >> $GITHUB_OUTPUT
            echo "policy_arn=$POLICY_ARN" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è IAM Policy n√£o encontrada"
            echo "policy_exists=false" >> $GITHUB_OUTPUT
          fi

      # Importar IAM Policy
      - name: Importar IAM Policy
        if: env.TF_ACTION == 'destroy' && steps.iam_policy_check.outputs.policy_exists == 'true'
        working-directory: infra
        run: |
          echo "Importando IAM Policy..."
          terraform import aws_iam_policy.lambda_sns_policy "${{ steps.iam_policy_check.outputs.policy_arn }}" || echo "IAM Policy j√° importada ou n√£o existe"

      # Verificar attachment da IAM Policy na Role
      - name: Verificar attachment da IAM Policy
        if: env.TF_ACTION == 'destroy' &&
          steps.iam_policy_check.outputs.policy_exists == 'true' &&
          steps.iam_role_check.outputs.role_exists == 'true'
        id: iam_policy_attachment_check
        working-directory: infra
        run: |
          ROLE_NAME="${{ steps.iam_role_check.outputs.role_name }}"
          POLICY_ARN="${{ steps.iam_policy_check.outputs.policy_arn }}"
          
          # Valida√ß√£o defensiva
          if [ -z "$ROLE_NAME" ] || [ -z "$POLICY_ARN" ]; then
            echo "Vari√°veis obrigat√≥rias n√£o definidas, pulando verifica√ß√£o"
            echo "policy_attachment_exists=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          ATTACHED=$(aws iam list-attached-role-policies \
            --role-name "$ROLE_NAME" \
            --query "AttachedPolicies[?PolicyArn=='$POLICY_ARN'].PolicyArn" \
            --output text)
          
          if [ -n "$ATTACHED" ] && [ "$ATTACHED" != "None" ]; then
            echo "‚úÖ Attachment IAM Policy encontrado"
            echo "policy_attachment_exists=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Attachment IAM Policy n√£o encontrado"
            echo "policy_attachment_exists=false" >> $GITHUB_OUTPUT
          fi

      # Importar attachment da IAM Policy
      - name: Importar attachment da IAM Policy
        if: env.TF_ACTION == 'destroy' && steps.iam_policy_attachment_check.outputs.policy_attachment_exists == 'true'
        working-directory: infra
        run: |
          ROLE_NAME="${{ steps.iam_role_check.outputs.role_name }}"
          POLICY_ARN="${{ steps.iam_policy_check.outputs.policy_arn }}"
          
          terraform import aws_iam_role_policy_attachment.attach_sns_policy "${ROLE_NAME}/${POLICY_ARN}" || echo "Attachment j√° importado ou n√£o existe"

        # Verificar SNS Subscription
      - name: Verificar SNS Subscription
        id: get_sns_subscription
        run: |
          TOPIC_ARN="arn:aws:sns:${AWS_REGION}:${AWS_ACCOUNT_ID}:${SNS_NAME}"
          ENDPOINT="janainafrv@hotmail.com"
          
          set +e
          SUB_ARN=$(aws sns list-subscriptions-by-topic --topic-arn "$TOPIC_ARN" \
            --query "Subscriptions[?Endpoint=='$ENDPOINT'].SubscriptionArn" --output text 2>/dev/null)
          STATUS=$?
          set -e
          
          if [ $STATUS -ne 0 ]; then
            echo "‚ö†Ô∏è T√≥pico $TOPIC_ARN n√£o existe, pulando verifica√ß√£o"
            echo "exists=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ -n "$SUB_ARN" ] && [ "$SUB_ARN" != "None" ]; then
            echo "‚úÖ Subscription encontrada: $SUB_ARN"
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "SUB_ARN=$SUB_ARN" >> $GITHUB_ENV
          else
            echo "‚ö†Ô∏è Subscription n√£o encontrada"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      # Importar SNS Subscription se existir
      - name: Importar SNS Subscription se existir
        if: env.TF_ACTION == 'destroy' && steps.get_sns_subscription.outputs.exists == 'true'
        working-directory: infra
        run: |
          if [ -n "$SUB_ARN" ]; then
            echo "Importando SNS Subscription..."
            terraform import aws_sns_topic_subscription.feedback_email $SUB_ARN
          else
            echo "Nenhuma subscription para importar, pulando"
          fi
      

      # Verificar exist√™ncia do SNS
      - name: Verificar exist√™ncia de SNS
        id: sns_check
        run: |
          set +e
          SNS_ARN="arn:aws:sns:$AWS_REGION:$AWS_ACCOUNT_ID:$SNS_NAME"
          SNS_CHECK=$(aws sns get-topic-attributes --topic-arn "$SNS_ARN" --output text 2>/dev/null)
          set -e
          
          if [ -n "$SNS_CHECK" ]; then
          echo "‚úÖ SNS encontrado: $SNS_ARN"
          echo "sns_exists=true" >> $GITHUB_OUTPUT
          echo "sns_arn=$SNS_ARN" >> $GITHUB_OUTPUT
          else
          echo "‚ö†Ô∏è SNS n√£o encontrado."
          echo "sns_exists=false" >> $GITHUB_OUTPUT
          fi

      # Importar SNS se existir
      - name: Importar SNS se existir
        if: steps.sns_check.outputs.sns_exists == 'true'
        working-directory: infra
        run: |
          echo "Importando SNS para o estado..."
          terraform import aws_sns_topic.relatorio_feedbacks "${{ steps.sns_check.outputs.sns_arn }}" \
          || echo "‚ö†Ô∏è SNS j√° importado ou n√£o existe"

      # Verificar exist√™ncia do EventBridge Rule
      - name: Verificar exist√™ncia do EventBridge
        id: eventbridge_check
        run: |
          set +e
          RULE_NAME="event-relatorio-sns-15min"
          
          RULE_CHECK=$(aws events describe-rule \
            --name "$RULE_NAME" \
            --region "$AWS_REGION" \
            --output text 2>/dev/null)
          
          set -e
          
          if [ -n "$RULE_CHECK" ]; then
            echo "‚úÖ EventBridge Rule encontrada: $RULE_NAME"
            echo "eventbridge_exists=true" >> $GITHUB_OUTPUT
            echo "rule_name=$RULE_NAME" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è EventBridge Rule n√£o encontrada."
            echo "eventbridge_exists=false" >> $GITHUB_OUTPUT
          fi

      # Importar EventBridge Rule se existir
      - name: Importar EventBridge Rule
        if: steps.eventbridge_check.outputs.eventbridge_exists == 'true'
        working-directory: infra
        run: |
          echo "Importando EventBridge Rule para o state..."
          terraform import \
            aws_cloudwatch_event_rule.weekly_event \
            "${{ steps.eventbridge_check.outputs.rule_name }}" \
          || echo "‚ö†Ô∏è EventBridge Rule j√° importada ou n√£o existe"

      # Verificar exist√™ncia do EventBridge Target
      - name: Verificar exist√™ncia do EventBridge Target
        id: eventbridge_target_check
        run: |
          set +e
          RULE_NAME="event-relatorio-sns-15min"
          TARGET_ID="event-relatorio-sns"
          
          TARGET_CHECK=$(aws events list-targets-by-rule \
            --rule "$RULE_NAME" \
            --region "$AWS_REGION" \
            --query "Targets[?Id=='$TARGET_ID']" \
            --output text 2>/dev/null)
          
          set -e
          
          if [ -n "$TARGET_CHECK" ]; then
            echo "‚úÖ EventBridge Target encontrado: $TARGET_ID"
            echo "target_exists=true" >> $GITHUB_OUTPUT
            echo "rule_name=$RULE_NAME" >> $GITHUB_OUTPUT
            echo "target_id=$TARGET_ID" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è EventBridge Target n√£o encontrado."
            echo "target_exists=false" >> $GITHUB_OUTPUT
          fi

      # Importar EventBridge Target se existir
      - name: Importar EventBridge Target
        if: steps.eventbridge_target_check.outputs.target_exists == 'true'
        working-directory: infra
        run: |
          echo "üì• Importando EventBridge Target para o Terraform state..."
          terraform import aws_cloudwatch_event_target.lambda_target \
            "${{ steps.eventbridge_target_check.outputs.rule_name }}/${{ steps.eventbridge_target_check.outputs.target_id }}" \
            || echo "‚ö†Ô∏è Target j√° importado ou n√£o existe"

      # Verificar exist√™ncia da Lambda
      - name: Verificar exist√™ncia da Lambda
        id: lambda_check
        run: |
          if aws lambda get-function --function-name $FUNCTION_NAME >/dev/null 2>&1; then
            echo "‚úÖ Lambda encontrada: $FUNCTION_NAME"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Lambda n√£o encontrada."
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      # Importar Lambda se existir
      - name: Importar Lambda se existir
        if: env.TF_ACTION == 'destroy' && steps.lambda_check.outputs.exists == 'true'
        working-directory: infra
        run: |
          echo "Importando Lambda para o estado..."
          terraform import aws_lambda_function.${RESOURCE_NAME} ${FUNCTION_NAME} || echo "Lambda j√° importada ou n√£o existe"

      ###  Destruir recursos na ordem correta

      # Destruir EventBridge Target (Terraform destroy)
      - name: DESTROY - Destruir EventBridge Target
        if: env.TF_ACTION == 'destroy' && steps.eventbridge_target_check.outputs.target_exists == 'true'
        working-directory: infra
        run: |
          echo "üî• Destruindo EventBridge Target via Terraform..."
          terraform destroy -target=aws_cloudwatch_event_target.lambda_target -auto-approve

      # Destruir EventBridge Rule (se existir)
      - name: DESTROY - Destruir EventBridge Rule
        if: env.TF_ACTION == 'destroy' && steps.eventbridge_check.outputs.eventbridge_exists == 'true'
        working-directory: infra
        run: |
          echo "üî• EventBridge existe. Destruindo via Terraform..."
          terraform destroy -auto-approve

      # Destruir Lambda
      - name: DESTROY - Executar destroy da Lambda
        if: env.TF_ACTION == 'destroy' && steps.lambda_check.outputs.exists == 'true'
        working-directory: infra
        run: |
          echo "Destruindo Lambda..."
          terraform destroy -target=aws_lambda_function.${RESOURCE_NAME} -auto-approve

      # Destruir SNS Subscription
      - name: DESTROY - SNS Subscription (email)
        if: env.TF_ACTION == 'destroy' && steps.get_sns_subscription.outputs.exists == 'true'
        working-directory: infra
        run: |
          echo "Destruindo SNS Subscription (email)..."
          terraform destroy -target=aws_sns_topic_subscription.feedback_email -auto-approve

      # Destruir SNS
      - name: DESTROY - Executar destroy da SNS
        if: env.TF_ACTION == 'destroy' && steps.sns_check.outputs.sns_exists == 'true'
        working-directory: infra
        run: |
          echo "Destruindo SNS..."
          terraform destroy -target=aws_sns_topic.relatorio_feedbacks -auto-approve

      # Destruir attachment da IAM Policy (se existir)
      - name: DESTROY - Destruir attachment da IAM Policy
        if: env.TF_ACTION == 'destroy' && steps.iam_policy_attachment_check.outputs.policy_attachment_exists == 'true'
        working-directory: infra
        run: |
          echo "Destruindo attachment da IAM Policy..."
          terraform destroy -target=aws_iam_role_policy_attachment.attach_sns_policy -auto-approve || echo "Attachment n√£o encontrado ou j√° destru√≠do"

      # Destruir IAM Policy
      - name: DESTROY - Destruir IAM Policy
        if: env.TF_ACTION == 'destroy' && steps.iam_policy_check.outputs.policy_exists == 'true'
        working-directory: infra
        run: |
          echo "Destruindo IAM Policy..."
          terraform destroy -target=aws_iam_policy.lambda_sns_policy -auto-approve || echo "Policy n√£o encontrada ou j√° destru√≠da"

      # Destruir IAM Role
      - name: DESTROY - Destruir IAM Role
        if: env.TF_ACTION == 'destroy' && steps.iam_role_check.outputs.role_exists == 'true'
        working-directory: infra
        run: |
          echo "Destruindo IAM Role..."
          terraform destroy -target=aws_iam_role.lambda_exec_role -auto-approve || echo "Role n√£o encontrada ou j√° destru√≠da"

      ###  Criando recursos na ordem correta

      # Criar SNS
      - name: APPLY - Executar apply da SNS
        if: env.TF_ACTION == 'apply' && steps.sns_check.outputs.sns_exists == 'false'
        working-directory: infra
        run: |
          echo "Criando SNS..."
          terraform apply -target=aws_sns_topic.relatorio_feedbacks -auto-approve

      # Criar SNS Subscription (email)
      - name: APPLY - SNS Subscription (email)
        if: env.TF_ACTION == 'apply' && steps.get_sns_subscription.outputs.exists == 'false'
        working-directory: infra
        run: |
          echo "Criando SNS Subscription (email)..."
          terraform apply \
            -target=aws_sns_topic_subscription.feedback_email \
            -auto-approve

      # Criar ou importar Role
      - name: APPLY - Criar ou importar IAM Role
        if: env.TF_ACTION == 'apply'
        working-directory: infra
        run: |
          if [ "${{ steps.iam_role_check.outputs.role_exists }}" == "true" ]; then
            terraform import aws_iam_role.lambda_exec_role lambda-relatorio-role || echo "IAM Role j√° importada"
          else
            terraform apply -auto-approve -target=aws_iam_role.lambda_exec_role
          fi

      # Criar ou importar Policy
      - name: APPLY - Criar ou importar IAM Policy
        if: env.TF_ACTION == 'apply'
        working-directory: infra
        run: |
          if [ "${{ steps.iam_policy_check.outputs.policy_exists }}" == "true" ]; then
            terraform import aws_iam_policy.lambda_sns_policy arn:aws:iam::757367947438:policy/lambda-sqs-sns-policy || echo "IAM Policy j√° importada"
          else
            terraform apply -auto-approve -target=aws_iam_policy.lambda_sns_policy
          fi

      # Criar ou importar Attachments
      - name: APPLY - Criar attachment da IAM Policy na Role
        if: env.TF_ACTION == 'apply'
        working-directory: infra
        run: |
          if [ "${{ steps.iam_policy_check.outputs.policy_exists }}" == "true" ]; then
            echo "Attachments da IAM Policy na Role j√° foram feitos!"
            exit 0
          else
            echo "Criando attachments da IAM Policy na Role..."
            terraform apply -auto-approve \
              -target=aws_iam_role_policy_attachment.attach_sns_policy \
              -target=aws_iam_role_policy_attachment.lambda_vpc_access \
              -target=aws_iam_role_policy_attachment.lambda_basic_exec
          fi

      # Criar Lambda
      - name: APPLY - Instalar Java 21
        if: env.TF_ACTION == 'apply'
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build Lambda com Quarkus
        if: env.TF_ACTION == 'apply'
        working-directory: lambda
        run: mvn clean package -DskipTests

      - name: Copiar artefato da Lambda (Quarkus)
        if: env.TF_ACTION == 'apply'
        run: |
          mkdir -p infra/build/lambda
          cp lambda/target/function.zip infra/build/lambda/function.zip

      - name: APPLY - Criar ou atualizar Lambda
        if: env.TF_ACTION == 'apply'
        working-directory: infra
        run: |
          echo "Criando ou atualizando Lambda..."
          terraform apply -auto-approve

      # Criar EventBridge Rule (se n√£o existir)
      - name: APPLY - Criar EventBridge Rule
        if: env.TF_ACTION == 'apply' && steps.eventbridge_check.outputs.eventbridge_exists == 'false'
        working-directory: infra
        run: |
          echo "üöÄ EventBridge n√£o existe. Criando via Terraform..."
          terraform apply -auto-approve

      # Criar EventBridge Target (Terraform apply)
      - name: APPLY - Criar EventBridge Target
        if: env.TF_ACTION == 'apply' && steps.eventbridge_target_check.outputs.target_exists == 'false'
        working-directory: infra
        run: |
          echo "üöÄ Criando EventBridge Target via Terraform..."
          terraform apply -auto-approve
